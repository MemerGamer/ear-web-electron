<html>
<head>
</head>
<body>
    <button type="button" id="connect-spp">Connect Bluetooth </button><br />
    <script>

        let sppPort = null;

        const connectSppButton = document.getElementById('connect-spp');
        connectSppButton.addEventListener('click', connectSpp);

        function getModelInfo(modelID) {
            var models = {
                "31d53d": {
                    name: "Nothing Ear (1)",
                    leftImg: "../assets/ear_one_white_left.png",
                    caseImg: "../assets/ear_one_white_case.png",
                    rightImg: "../assets/ear_one_white_right.png",
                    duoImg: "../assets/ear_one_white_duo.png",
                    isANC: true
                },
                "624011": {
                    name: "Nothing Ear (1)",
                    leftImg: "../assets/ear_one_black_left.png",
                    caseImg: "../assets/ear_one_black_case.png",
                    rightImg: "../assets/ear_one_black_right.png",
                    duoImg: "../assets/ear_one_black_duo.png",
                    isANC: true
                },
                "1016dd": {
                    name: "Nothing Ear (stick)",
                    leftImg: "../assets/ear_stick_left.png",
                    caseImg: "../assets/ear_stick_case_none.png",
                    rightImg: "../assets/ear_stick_right.png",
                    duoImg: "../assets/ear_stick_white_duo.png",
                    isANC: false
                },
                "dee8c0": {
                    name: "Nothing Ear (2)",
                    leftImg: "../assets/ear_two_white_left.png",
                    caseImg: "../assets/ear_two_white_case.png",
                    rightImg: "../assets/ear_two_white_right.png",
                    duoImg: "../assets/ear_two_white_duo.png",
                    isANC: true
                },
                "acc520": {
                    name: "Nothing Ear (2)",
                    leftImg: "../assets/ear_two_black_left.png",
                    caseImg: "../assets/ear_two_black_case.png",
                    rightImg: "../assets/ear_two_black_right.png",
                    duoImg: "../assets/ear_two_black_duo.png",
                    isANC: true
                }
            };
            return models[modelID];
        }

        async function connectSpp() {
            const SPP_UUID = "aeac4a03-dff5-498f-843a-34487cf133eb";
            const FASTPAIR_UUID = "df21fe2c-2515-4fdb-8886-f12c4d67927c";
            sppPort = await navigator.serial.requestPort({
                allowedBluetoothServiceClassIds: [FASTPAIR_UUID],
                filters: [{ bluetoothServiceClassId: FASTPAIR_UUID }],
            });

            if (sppPort) {
                console.log('connected to a Bluetooth Serial Port Profile port', sppPort.getInfo());
                //print mac address of the connected device
                console.log(sppPort);
                await sppPort.open({ baudRate: 9600 });
                //read from the serial port
                const reader = sppPort.readable.getReader();
                while (true) {
                    const { value, done } = await reader.read();
                    //console.log(value);
                    //print hex string of the received data
                    var string = "";
                    for (let i = 0; i < value.length; i++) {
                        //fill the string with leading zero if needed
                        string += (value[i] < 16 ? "0" : "") + value[i].toString(16);
                    }
                    console.log(string);
                    if (done) {
                        // Allow the serial port to be closed later.
                        reader.releaseLock();
                        break;
                    }
                    console.log(value);
                    //if received data is 7 bytes long, disconnect
                    if (value.length == 7) {
                        reader.releaseLock();
                        await sppPort.close();
                        var modelID = string.substring(8, 14);
                        console.log(modelID);
                        var modelInfo = getModelInfo(modelID);
                        console.log(modelInfo);
                        break;
                    }
                }
            }
        }


    </script>
</body>
</html>